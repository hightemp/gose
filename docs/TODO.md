Отчет о состоянии и том, что еще не реализовано — обновлено 2025-09-20

Бэкенд краулера

Сделанные и частично сделанные задачи (MVP реализован в [search_crawler_service/main.go](search_crawler_service/main.go)):
- [x] Рабочий воркер краулинга: выбор задач из очереди (SELECT FOR UPDATE SKIP LOCKED), статусы processing/done/error, attempts и next_try_at для ретраев (базово).
- [x] Пер‑хост rate limit: ограничение RPS/burst на хост.
- [x] Сохранение результата обхода в БД: pages.html + pages.text + upsert, FTS обновляется триггером. Примечание: title/description/lang пока не извлекаются.
- [x] Извлечение ссылок с страницы и пополнение фронтира: парсинг <a href>, фильтрация http/https, нормализация host, только in‑domain; запись в page_links и enqueue без дублей.
- [-] HTTP fetcher с поддержкой прокси: таймауты, корректный User‑Agent, ограничение размера тела, следование редиректам по умолчанию, поддержка http/https‑прокси (round‑robin). Нет: ретраев, socks5.
- [-] Ротация прокси и бан‑политика: простая round‑robin реализована; отсутствуют бан по ошибкам и healthcheck из [deploy/proxies.yaml](deploy/proxies.yaml).
- [ ] Поддержка robots.txt: загрузка/кэш, Disallow/Allow, Crawl‑delay.
- [ ] Парсинг sitemap и получение стартовых URL с TTL/переобновлением.
- [-] Нормализация/каноникализация URL: удаление фрагмента и нормализация host сделаны; сортировка query, удаление трекинга и пр. — TODO.
- [ ] Телеметрия/метрики (/metrics, статусы, длительности, состояние пула прокси).
- [-] Фоновый процессор/планировщик: базовый цикл воркеров запущен, приоритезация/расписание — упрощены.

Оставшиеся детали реализации будут вестись в рамках следующих задач.

Поисковый UI
- [x] Оформление главной и результатов в стиле Google: переработаны шаблоны [index.html](search_ui_service/templates/index.html) и [results.html](search_ui_service/templates/results.html).
- [x] Подсветка совпадений: корректный вывод <mark> через функцию шаблона raw; см. [search_ui_service/main.go](search_ui_service/main.go:78).
- [x] Сортировка: релевантность/свежесть поддерживаются параметром sort; баг ORDER BY с alias устранён подзапросом; см. [Server.query()](search_ui_service/main.go:241).
- [x] Удалён фильтр по домену из UI по требованию.
- [x] Пагинация: функции add/sub/mul подключены; см. [search_ui_service/main.go](search_ui_service/main.go:78).
- [x] Шаблон результатов [results.html](search_ui_service/templates/results.html) подключён и используется.
- [ ] HTMX/частичные рендеры для интерактивной подгрузки — не реализовано.
- [ ] Переключение языка подсветки (ru/en) — не реализовано.

Manager UI
- [ ] Сервис отсутствует кроме go.mod: нужны основной сервер, базовая аутентификация, CRUD сайтов/seed URL, действия recrawl, дашборды по очереди/ошибкам, YAML‑конфиг (см. [deploy/manager_ui.config.yaml](deploy/manager_ui.config.yaml)).
- [ ] Нет API/вьюх для управления лимитами RPS на домен, включением/выключением сайтов.

Domain search
- [ ] В целом готов как MVP (генерация и запись напрямую в БД), но нет:
  - механизм бэкпрешсера по размеру очереди (не замедляет генерацию, если очередь переполнена);
  - сохранения прогресса/возобновления (state) и мониторинга/метрик;
  - опциональной записи как http:// при отказе https:// с записью фактического протокола.

Интеграции и документация
- [ ] Нет зафиксированного контракта интеграции с сервисом прокси‑проверки (формат REST/ответов), помимо файла [deploy/proxies.yaml](deploy/proxies.yaml). Документация этого контракта не добавлена в [docs/PROJECT.md](docs/PROJECT.md).
- [ ] Нет интеграционных тестов: прогон тестового домена, попадание в очередь, индексация страницы, успешный поиск.
- [ ] Нет smoke‑теста docker compose up (скрипт/Make цель) для быстрой проверки healthchecks и открытия UI.

Инфраструктура/прочее
- [ ] Нет Makefile для всех сервисов (есть для crawler/ui, отсутствуют для domain_search/site_manager системные цели test/run/build в едином стиле).
- [ ] Нет endpoint’ов в краулере для служебной диагностики (например, просмотр размера фронтира по домену, последние ошибки).
- [ ] Нет полноценных .gitignore и корневого Makefile (корневой Makefile пуст).
- [ ] Нет логирования на уровне структурированных логов с полями (site, url_hash, статус, длительности).